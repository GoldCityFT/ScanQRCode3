<!DOCTYPE html>
<html lang="th">
<head>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta charset="UTF-8">
<title>‡∏™‡πÅ‡∏Å‡∏ô QR Code</title>
<script src="https://unpkg.com/html5-qrcode"></script>
<style>
/* ‡∏õ‡∏£‡∏±‡∏ö body / html */
html, body {
  margin: 0;
  padding: 0;
  height: 100%;
  width: 100%;
  font-family: 'Prompt', sans-serif;
  background: black;
  display: flex;
  justify-content: center;
  align-items: center;
}

/* QR Reader */
#reader {
  width: 100%;
  height: 75%;
  position: relative;
  z-index: 0;
  display:none;
}

#overlay {
  position: absolute;
  top: 0; left: 0;
  width: 100%; height: 100%;
  pointer-events: none;
  z-index: 1;
  display:none;
}

#message {
  position: fixed; 
  top: 20px;
  left: 0;
  width: 100%;
  text-align: center;
  color: white;
  font-size: clamp(1.5rem, 5vw, 2rem);
  font-weight: bold;
  text-shadow: 0 0 5px black;
  z-index: 2;
  display:none;
}

/* popup ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Scan / Manual */
#popupMode {
  display:flex;
  position:fixed;
  top:0; left:0; right:0; bottom:0;
  background:rgba(0,0,0,0.6);
  justify-content:center;
  align-items:center;
  z-index:9999;
}

#popupModeContent {
  background:#fff;
  padding:30px 20px;
  border-radius:20px;
  text-align:center;
  font-size: clamp(18px, 4vw, 28px);
  font-weight:bold;
  color:#333;
  min-width:280px;
  max-width:400px;
  width:90%;
  box-shadow:0 8px 25px rgba(0,0,0,0.5);
  display:flex;
  flex-direction:column;
  align-items:center;
  gap:15px; /* ‡∏£‡∏∞‡∏¢‡∏∞‡∏´‡πà‡∏≤‡∏á‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á element */
}

  #popupModeContent p {
  margin-bottom: 10px;
  font-size: clamp(16px, 4vw, 22px);
  color: #444;
}

  
#popupModeContent button {
  width:100%;
  padding:15px 20px;
  border:none;
  border-radius:12px;
  background:#00C300;
  color:white;
  font-size:1.1rem;
  cursor:pointer;
  transition: all 0.2s ease-in-out;
  display:flex;
  justify-content:center;
  align-items:center;
  gap:8px;
}

#popupModeContent button:hover { 
  background:#009f2b; 
  transform: scale(1.03);
}

/* popup ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô / Alert */
#popupAlert {
  display:none;
  position:fixed;
  top:0; left:0; right:0; bottom:0;
  background:rgba(0,0,0,0.6);
  justify-content:center;
  align-items:center;
  z-index:9999;
}

#popupAlertContent {
  background:#fff;
  padding:40px;
  border-radius:20px;
  text-align:center;
  font-size: clamp(20px, 5vw, 32px);
  font-weight:bold;
  color:#333;
  min-width:300px;
  max-width:90%;
  box-shadow:0 8px 25px rgba(0,0,0,0.5);
}

/* manual input */
#manualInput {
  display:none;
  flex-direction: column;
  align-items:center;
  justify-content:center;
  position: fixed;
  bottom: 20px; /* ‡∏≠‡∏¢‡∏π‡πà‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á */
  left: 50%;
  transform: translateX(-50%); /* ‡∏Å‡∏∂‡πà‡∏á‡∏Å‡∏•‡∏≤‡∏á‡πÅ‡∏ô‡∏ß‡∏ô‡∏≠‡∏ô */
  z-index:5;
  width: 90%;
  max-width: 400px;
}

#manualInput input {
  padding: 12px;
  margin-top: 8px;
  border-radius: 10px;
  border: 2px solid #ccc;
  font-size: 1.4rem; /* ‡πÄ‡∏•‡πá‡∏Å‡∏•‡∏á */
  width: 100%;
  box-sizing: border-box;
  text-align: center;
}

#manualSubmit {
  margin-top: 10px;
  padding: 12px;
  border: none;
  border-radius: 10px;
  background: #00C300;
  color: white;
  font-size: 1.4rem; /* ‡πÄ‡∏•‡πá‡∏Å‡∏•‡∏á */
  font-weight: bold;
  cursor: pointer;
  width: 100%;
  transition: all 0.2s ease-in-out;
}

#manualSubmit:hover {
  background: #009f2b;
  transform: scale(1.03);
}


</style>
</head>
<body>
<div id="reader"></div>
<div id="overlay"></div>
<div id="message">‡∏™‡πÅ‡∏Å‡∏ô QR Code ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏õ‡πá‡∏ô‡πÅ‡∏ô‡∏ß‡∏ï‡∏±‡πâ‡∏á</div>

<!-- popup ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Scan / Manual / Lost -->
<div id="popupMode">
  <div id="popupModeContent">
<p style="font-size: 22px; font-weight: bold;">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏¥‡∏ò‡∏µ‡∏Å‡∏£‡∏≠‡∏Å QR Code</p>
<button id="popupScanOrManualBtn">üì¶ <span>‡∏™‡πÅ‡∏Å‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏û‡∏±‡∏™‡∏î‡∏∏</span></button>
<button id="popupLostBtn">‚ùå <span>‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏£‡∏∞‡∏ö‡∏∏‡∏£‡∏´‡∏±‡∏™‡∏û‡∏±‡∏™‡∏î‡∏∏‡πÑ‡∏î‡πâ</span></button>
  </div>
</div>

<!-- popup ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô -->
<div id="popupAlert">
  <div id="popupAlertContent">
    <p id="popupAlertText">‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô</p>
    <div id="popupAlertButtons"></div> <!-- ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Customer -->
  </div>
</div>

<!-- manual input -->
<div id="manualInput">
 <p style="color:white; font-size:1.2rem; margin-bottom:10px; text-align:center;">
  ‡∏´‡∏£‡∏∑‡∏≠‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏û‡∏±‡∏™‡∏î‡∏∏‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á (‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏™‡∏∞‡∏î‡∏ß‡∏Å‡∏™‡πÅ‡∏Å‡∏ô QR)
</p>
  <input type="text" id="manualCode" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡πÇ‡∏Ñ‡πâ‡∏î‡∏î‡πâ‡∏ß‡∏¢‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á">
  <button id="manualSubmit">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</button>
</div>

  <!-- popup loading -->
<div id="popupLoading" style="
    display:none;
    position: fixed;
    top:0; left:0; right:0; bottom:0;
    background: rgba(0,0,0,0.6);
    justify-content:center;
    align-items:center;
    z-index:99999;
">
  <div style="
      background:#fff;
      padding:30px 20px;
      border-radius:20px;
      font-size:1.5rem;
      font-weight:bold;
      text-align:center;
      color:#333;
      box-shadow:0 8px 25px rgba(0,0,0,0.5);
  ">
    ‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...
  </div>
</div>

<script>
let isScanned = false;
let html5QrCode = null;
let currentMode = null;
const appsScriptURL = "https://script.google.com/macros/s/AKfycbxWOLfJ1MIeN_3RmZ1slHlSD6omtSmJUR1EemXyl8Gf_ykI8XY3oSLg75HNmH_fM9w/exec";

// fetch ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Apps Script
// --- ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô fetch ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏†‡∏≤‡∏¢‡πÉ‡∏ô processCode ---
async function fetchTrackingData(trackingCode){
  try {
    const res = await fetch(`${appsScriptURL}?tracking=${encodeURIComponent(trackingCode)}`);
    const data = await res.json();
    return data;
  } catch(err) {
    console.error("Fetch error:", err);
    return { success:false, data:[] };
  }
}

// message = ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô
// redirect = true/false (default true)
function showAlertPopup(message, redirect = true){
  // ‡∏õ‡∏¥‡∏î popupMode ‡πÅ‡∏•‡∏∞ manualInput
  document.getElementById('popupMode').style.display = 'none';
  document.getElementById('manualInput').style.display = 'none';

    // ‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£ popup ‡πÅ‡∏•‡∏∞ text
  const popup = document.getElementById("popupAlert");
  const text = document.getElementById("popupAlertText");
  
  text.textContent = message;
  // ‡∏õ‡∏¥‡∏î‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏Å‡πà‡∏≤
  const btnContainer = document.getElementById("popupAlertButtons");
  btnContainer.innerHTML = "";
  popup.style.display = "flex";

  setTimeout(()=>{
    popup.style.display = "none";
    isScanned = false; // reset flag

    if(redirect){
      window.location.href = "Form3.html";
    }
  }, 2000);
}

  // ‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° Lost ‚Üí ‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤ Losstrackingcode.html
document.getElementById('popupLostBtn').onclick = () => {
  window.location.href = "Losstrackingcode3.html";
};


function showPopupWithSelection(dataArray, callback){
  
  const popup = document.getElementById("popupAlert");
  const text = document.getElementById("popupAlertText");
  const btnContainer = document.getElementById("popupAlertButtons");

  // ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ô‡∏≥
  text.textContent = "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡∏≠‡∏á‡∏ó‡πà‡∏≤‡∏ô";

  // ‡∏•‡πâ‡∏≤‡∏á‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏Å‡πà‡∏≤
  btnContainer.innerHTML = "";

  // ‡∏õ‡∏∏‡πà‡∏°‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏ï‡πà‡∏•‡∏∞ Customer
  dataArray.forEach((row) => {
    const btn = document.createElement("button");
    btn.style.margin = "5px 0";
    btn.style.width = "100%";
    btn.style.padding = "10px";
    btn.style.fontSize = "1rem";

     // ‡πÉ‡∏ä‡πâ‡∏ä‡∏∑‡πà‡∏≠ field ‡∏à‡∏£‡∏¥‡∏á‡∏à‡∏≤‡∏Å Apps Script
    const name = row.CustomerName || row.Name || '';
    const code = row.BillingPostCode || row.PostCode || '';
    const tracking = row.TrackingCode || row.Code || '';
    
   btn.textContent = `${name}  ${code}  ${tracking}`;
    btn.onclick = () => {
    popup.style.display = "none";
    if(callback) callback(row);
  };
  btnContainer.appendChild(btn);
});

  // ‡∏õ‡∏∏‡πà‡∏° "‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•"
  const skipBtn = document.createElement("button");
  skipBtn.style.marginTop = "10px";
  skipBtn.style.width = "100%";
  skipBtn.style.padding = "10px";
  skipBtn.style.background = "#FF5722";
  skipBtn.style.color = "white";
  skipBtn.style.fontWeight = "bold";
  skipBtn.textContent = "‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ô";
  skipBtn.onclick = () => {
    popup.style.display = "none";
    window.location.href = "Form2.html";
  };
  btnContainer.appendChild(skipBtn);

  popup.style.display = "flex";
  }
  
// ‡πÉ‡∏ä‡πâ‡∏Å‡∏±‡∏ö‡∏ó‡∏±‡πâ‡∏á QR ‡πÅ‡∏•‡∏∞ Manual
async function processCode(code){
  if(!code) return;

  const scannedCodes = JSON.parse(sessionStorage.getItem('scannedCodes') || '[]');

  if(scannedCodes.includes(code)) {
    showAlertPopup("‚ö†Ô∏è ‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏Ñ‡∏¢‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏µ‡πâ‡πÅ‡∏•‡πâ‡∏ß", true);
    return;
  }

  // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏ó‡∏µ‡πà‡∏™‡πÅ‡∏Å‡∏ô‡πÅ‡∏•‡πâ‡∏ß ‡πÅ‡∏ï‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏™‡πà‡∏á‡πÑ‡∏õ backend
  scannedCodes.push(code);
  sessionStorage.setItem('tracking', code);
  sessionStorage.setItem('scannedCodes', JSON.stringify(scannedCodes));

  // --- ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å App Script ---
  const data = await fetchTrackingData(code);

  if(data.success && data.data.length > 0){
    // --- ‡πÅ‡∏™‡∏î‡∏á popup ‡πÉ‡∏´‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ---
    showPopupWithSelection(data.data, async (selectedRow) => {
      // ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏ñ‡∏ß ‚Üí ‡∏™‡πà‡∏á‡πÑ‡∏õ backend
      sessionStorage.setItem('selectedRow', JSON.stringify(selectedRow));
      try {
        await fetch('/api/updateTracking', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ tracking: selectedRow.TrackingCode })
        });
        // --- ‡πÅ‡∏™‡∏î‡∏á popup ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ---
        showAlertPopup("‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢!", true);
      } catch(err){
        console.error('Update backend failed:', err);
        showAlertPopup("‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å");
      }
    });
  } else {
    showAlertPopup("‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•", true);
  }
}


  
// Scan mode
async function scanQRCode() {
  const scannedCodes = JSON.parse(sessionStorage.getItem('scannedCodes') || '[]');
  if(scannedCodes.length > 0){
    showAlertPopup("‚ö†Ô∏è ‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏Ñ‡∏¢‡∏™‡πÅ‡∏Å‡∏ô QR Code ‡∏ô‡∏µ‡πâ‡πÅ‡∏•‡πâ‡∏ß");
    return;
  }

  document.getElementById('popupMode').style.display = 'none';
  document.getElementById('reader').style.display = 'block';
  document.getElementById('overlay').style.display = 'block';
  document.getElementById('message').style.display = 'block';

  // ‡πÇ‡∏ä‡∏ß‡πå Manual input ‡∏î‡πâ‡∏ß‡∏¢ (‡∏à‡∏∞‡∏ã‡πà‡∏≠‡∏ô‡∏ï‡∏≠‡∏ô‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πâ)
  document.getElementById('manualInput').style.display = 'flex';
  
  currentMode = "scan";
  isScanned = false;

  //manual + submit
document.getElementById('manualSubmit').onclick=async ()=>{
    if(isScanned){
    showAlertPopup("‚ö†Ô∏è ‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏î‡πâ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡πâ‡∏ß", false);
    return;
  }
  const code = document.getElementById('manualCode').value.trim();
  if(!code){
    showAlertPopup("‚ùå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡πÇ‡∏Ñ‡πâ‡∏î‡∏î‡πâ‡∏ß‡∏¢‡∏Ñ‡∏£‡∏±‡∏ö", false);
    return;
  }

  // ‡πÅ‡∏™‡∏î‡∏á popup ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•
  showLoadingPopup(true);

  try{
    await processCode(code);
  } finally {
    // ‡∏õ‡∏¥‡∏î popup ‡∏´‡∏•‡∏±‡∏á‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÄ‡∏™‡∏£‡πá‡∏à
    showLoadingPopup(false);
  }
};

  main();
  
}

// QR function
async function main() {
  if (!html5QrCode) html5QrCode = new Html5Qrcode("reader");
  const config = { fps:10, qrbox:(w,h)=>{ const s=w*0.6; return {width:s,height:s}; 
    }
    };
  html5QrCode.start(
    { facingMode: "environment" },
    config,
    async qrCodeMessage => {
      if(isScanned) return;
      isScanned = true;
      await processCode(qrCodeMessage.trim());
    },
    errorMessage => { console.log("Scanning...", errorMessage); }
  ).catch(err=>{
    console.error("Camera start error:", err);
    showAlertPopup("‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÑ‡∏î‡πâ", false);
  });
}

  // ‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Scan / Manual
document.getElementById('popupScanOrManualBtn').onclick = scanQRCode;

  function showLoadingPopup(show = true){
  document.getElementById('popupLoading').style.display = show ? 'flex' : 'none';
}

  
  
// ‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏ô‡πâ‡∏≤ / reload
window.addEventListener('pageshow', () => {
  const scannedCodes = JSON.parse(sessionStorage.getItem('scannedCodes') || '[]');
  if(scannedCodes.length > 0){
    // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏Ñ‡∏¢‡∏™‡πÅ‡∏Å‡∏ô‡πÅ‡∏•‡πâ‡∏ß ‚Üí ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô ‡πÅ‡∏•‡∏∞‡πÑ‡∏õ Form
    showAlertPopup("‚ö†Ô∏è ‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏Ñ‡∏¢‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏µ‡πâ‡πÅ‡∏•‡πâ‡∏ß", true);
  } else {
    // ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏Ñ‡∏¢‡∏™‡πÅ‡∏Å‡∏ô ‚Üí ‡πÅ‡∏™‡∏î‡∏á popup ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏´‡∏°‡∏î
    document.getElementById('popupMode').style.display = 'flex';
  }
});
  
</script>
</body>
</html>

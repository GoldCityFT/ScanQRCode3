<!DOCTYPE html>
<html lang="th">
<head>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta charset="UTF-8">
<title>‡∏™‡πÅ‡∏Å‡∏ô QR Code</title>
<script src="https://unpkg.com/html5-qrcode"></script>
<style>
/* ‡∏õ‡∏£‡∏±‡∏ö body / html */
html, body {
  margin: 0;
  padding: 0;
  height: 100%;
  width: 100%;
  font-family: 'Prompt', sans-serif;
  background: black;
  display: flex;
  justify-content: center;
  align-items: center;
}

/* QR Reader */
#reader {
  width: 100%;
  height: 75%;
  position: relative;
  z-index: 0;
  display:none;
}

#overlay {
  position: absolute;
  top: 0; left: 0;
  width: 100%; height: 100%;
  pointer-events: none;
  z-index: 1;
  display:none;
}

#message {
  position: fixed; 
  top: 20px;
  left: 0;
  width: 100%;
  text-align: center;
  color: white;
  font-size: clamp(1.5rem, 5vw, 2rem);
  font-weight: bold;
  text-shadow: 0 0 5px black;
  z-index: 2;
  display:none;
}

/* popup ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Scan / Manual */
#popupMode {
  display:flex;
  position:fixed;
  top:0; left:0; right:0; bottom:0;
  background:rgba(0,0,0,0.6);
  justify-content:center;
  align-items:center;
  z-index:9999;
}

#popupModeContent {
  background:#fff;
  padding:30px 20px;
  border-radius:20px;
  text-align:center;
  font-size: clamp(18px, 4vw, 28px);
  font-weight:bold;
  color:#333;
  min-width:280px;
  max-width:400px;
  width:90%;
  box-shadow:0 8px 25px rgba(0,0,0,0.5);
  display:flex;
  flex-direction:column;
  align-items:center;
  gap:15px; /* ‡∏£‡∏∞‡∏¢‡∏∞‡∏´‡πà‡∏≤‡∏á‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á element */
}

  #popupModeContent p {
  margin-bottom: 10px;
  font-size: clamp(16px, 4vw, 22px);
  color: #444;
}

  
#popupModeContent button {
  width:100%;
  padding:15px 20px;
  border:none;
  border-radius:12px;
  background:#00C300;
  color:white;
  font-size:1.1rem;
  cursor:pointer;
  transition: all 0.2s ease-in-out;
  display:flex;
  justify-content:center;
  align-items:center;
  gap:8px;
}

#popupModeContent button:hover { 
  background:#009f2b; 
  transform: scale(1.03);
}

/* popup ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô / Alert */
#popupAlert {
  display:none;
  position:fixed;
  top:0; left:0; right:0; bottom:0;
  background:rgba(0,0,0,0.6);
  justify-content:center;
  align-items:center;
  z-index:9999;
}

#popupAlertContent {
  background:#fff;
  padding:40px;
  border-radius:20px;
  text-align:center;
  font-size: clamp(20px, 5vw, 32px);
  font-weight:bold;
  color:#333;
  min-width:300px;
  max-width:90%;
  box-shadow:0 8px 25px rgba(0,0,0,0.5);
}

/* manual input */
#manualInput {
  display:none;
  flex-direction: column;
  align-items:center;
  justify-content:center;
  position: fixed;
  bottom: 20px; /* ‡∏≠‡∏¢‡∏π‡πà‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á */
  left: 50%;
  transform: translateX(-50%); /* ‡∏Å‡∏∂‡πà‡∏á‡∏Å‡∏•‡∏≤‡∏á‡πÅ‡∏ô‡∏ß‡∏ô‡∏≠‡∏ô */
  z-index:5;
  width: 90%;
  max-width: 400px;
}

#manualInput input {
  padding: 12px;
  margin-top: 8px;
  border-radius: 10px;
  border: 2px solid #ccc;
  font-size: 1.4rem; /* ‡πÄ‡∏•‡πá‡∏Å‡∏•‡∏á */
  width: 100%;
  box-sizing: border-box;
  text-align: center;
}

#manualSubmit {
  /*margin-top: 10px;*/
  padding: 12px;
  border: none;
  border-radius: 10px;
  background: #00C300;
  color: white;
  font-size: 1.2rem; /* ‡πÄ‡∏•‡πá‡∏Å‡∏•‡∏á */
  font-weight: bold;
  cursor: pointer;
  /*width: 100%;*/
  transition: all 0.2s ease-in-out;
}

#manualSubmit:hover {
  background: #009f2b;
  transform: scale(1.03);
}


</style>
</head>
<body>
<div id="reader"></div>
<div id="overlay"></div>
<div id="message">‡∏™‡πÅ‡∏Å‡∏ô QR Code ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏õ‡πá‡∏ô‡πÅ‡∏ô‡∏ß‡∏ï‡∏±‡πâ‡∏á</div>

<!-- popup ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Scan / Manual / Lost -->
<div id="popupMode">
  <div id="popupModeContent">
<p style="font-size: 22px; font-weight: bold;">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏¥‡∏ò‡∏µ‡∏Å‡∏£‡∏≠‡∏Å QR Code</p>
<button id="popupScanOrManualBtn">üì¶ <span>‡∏™‡πÅ‡∏Å‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏û‡∏±‡∏™‡∏î‡∏∏</span></button>
<button id="popupLostBtn">‚ùå <span>‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏£‡∏∞‡∏ö‡∏∏‡∏£‡∏´‡∏±‡∏™‡∏û‡∏±‡∏™‡∏î‡∏∏‡πÑ‡∏î‡πâ</span></button>
  </div>
</div>

<!-- popup ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô -->
<div id="popupAlert">
  <div id="popupAlertContent">
    <p id="popupAlertText">‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô</p>
    <div id="popupAlertButtons"></div> <!-- ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Customer -->
  </div>
</div>

<!-- manual input -->
<div id="manualInput">
 <p style="color:white; font-size:1.2rem; margin-bottom:10px; text-align:center;">
  ‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏û‡∏±‡∏™‡∏î‡∏∏‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á (‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏™‡∏∞‡∏î‡∏ß‡∏Å‡∏™‡πÅ‡∏Å‡∏ô)
</p>
  <input type="text" id="manualCode" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏î‡πâ‡∏ß‡∏¢‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á">
 <div style="display:flex; gap:10px; width:100%; margin-top:10px;">
  
  <button id="manualSubmit" style="
      flex:1;
      padding:12px;
      border:none;
      border-radius:10px;
      background:#00C300;
      color:white;
      font-size:1.2rem;
      font-weight:bold;
      cursor:pointer;
  ">
    ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô
  </button>

  <button id="btnBackToCamera" style="
      flex:1;
      padding:12px;
      border:none;
      border-radius:10px;
      background:#555;
      color:white;
      font-size:1.2rem;
      font-weight:bold;
      cursor:pointer;
  ">
    ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡πÉ‡∏ä‡πâ‡∏Å‡∏•‡πâ‡∏≠‡∏á
  </button>

</div>
</div>

  <!-- popup loading -->
<div id="popupLoading" style="
    display:none;
    position: fixed;
    top:0; left:0; right:0; bottom:0;
    background: rgba(0,0,0,0.6);
    justify-content:center;
    align-items:center;
    z-index:99999;
">
  <div style="
      background:#fff;
      padding:30px 20px;
      border-radius:20px;
      font-size:1.5rem;
      font-weight:bold;
      text-align:center;
      color:#333;
      box-shadow:0 8px 25px rgba(0,0,0,0.5);
  ">
    ‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...
  </div>
</div>
  
<script>
  // ===== Flow guard (ScanQrcode3) =====
const FLOW_TTL_MS = 10 * 60 * 1000; // ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥ 10 ‡∏ô‡∏≤‡∏ó‡∏µ
const INDEX_URL = "index.html";     // ‚úÖ ‡∏õ‡∏£‡∏±‡∏ö‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ü‡∏•‡πå‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏Ç‡∏≠‡∏á‡∏à‡∏£‡∏¥‡∏á (index.html / Index.html)

function touchFlow(){
  sessionStorage.setItem("flow_last_touch", String(Date.now()));
}

function isFlowExpired(){
  const last = Number(sessionStorage.getItem("flow_last_touch") || 0);
  return !last || (Date.now() - last) > FLOW_TTL_MS;
}

function guardFlowOrRestart(){
  // ‡πÑ‡∏°‡πà‡∏°‡∏µ run id = ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏à‡∏≤‡∏Å Index (‡∏´‡∏£‡∏∑‡∏≠‡πÇ‡∏î‡∏ô‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå) ‚Üí ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà
  const runId = sessionStorage.getItem("flow_run_id");
  if(!runId || isFlowExpired()){
    window.location.replace(INDEX_URL);
    return false;
  }
  return true;
}

// ‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏ô‡πâ‡∏≤ / reload
// ‡∏Å‡∏±‡∏ô BFCache: ‡∏ñ‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ñ‡∏π‡∏Å restore ‡∏à‡∏≤‡∏Å back/forward cache ‚Üí ‡∏£‡∏µ‡∏™‡∏ï‡∏≤‡∏£‡πå‡∏ó‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ‡πÉ‡∏´‡∏°‡πà
window.addEventListener("pageshow", (e) => {
  if (e.persisted) {
    window.location.replace("ScanQrcode3.html");
    return;
  }

  if(!guardFlowOrRestart()) return;
  touchFlow();

  const scannedCodes = JSON.parse(sessionStorage.getItem('scannedCodes') || '[]');
  if(scannedCodes.length > 0){
    showAlertPopup("‚ö†Ô∏è ‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏Ñ‡∏¢‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏µ‡πâ‡πÅ‡∏•‡πâ‡∏ß", true);
  } else {
    document.getElementById('popupMode').style.display = 'flex';
  }
});

// ‡πÄ‡∏ß‡∏•‡∏≤‡πÉ‡∏Å‡∏•‡πâ‡∏õ‡∏¥‡∏î/‡∏ã‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤ ‚Üí touch ‡πÑ‡∏ß‡πâ‡∏´‡∏ô‡πà‡∏≠‡∏¢ (‡∏Å‡∏±‡∏ô TTL ‡∏ï‡∏±‡∏î‡∏Å‡∏•‡∏≤‡∏á‡∏≠‡∏≤‡∏Å‡∏≤‡∏®‡πÅ‡∏ö‡∏ö‡∏á‡∏á ‡πÜ)
document.addEventListener("visibilitychange", () => {
  if (document.visibilityState === "visible") touchFlow();
});
  
let isScanned = false;
let html5QrCode = null;
let currentMode = null;
const appsScriptURL = "https://script.google.com/macros/s/AKfycbxWOLfJ1MIeN_3RmZ1slHlSD6omtSmJUR1EemXyl8Gf_ykI8XY3oSLg75HNmH_fM9w/exec";

// fetch ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Apps Script
// --- ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô fetch ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏†‡∏≤‡∏¢‡πÉ‡∏ô processCode ---
async function fetchTrackingData(trackingCode){
  try {
    const res = await fetch(`${appsScriptURL}?tracking=${encodeURIComponent(trackingCode)}`);
    const data = await res.json();
    return data;
  } catch(err) {
    console.error("Fetch error:", err);
    return { success:false, data:[] };
  }
}

// message = ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô
// redirect = true/false (default true)
async function showAlertPopup(message, redirect = true){
  const popupMode   = document.getElementById('popupMode');
  const manualInput = document.getElementById('manualInput');
  const reader      = document.getElementById('reader');
  const overlay     = document.getElementById('overlay');
  const msg         = document.getElementById('message');

  // ‚úÖ ‡∏à‡∏≥ state ‡πÄ‡∏î‡∏¥‡∏°‡πÑ‡∏ß‡πâ (‡∏Å‡πà‡∏≠‡∏ô‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á popup)
  const prev = {
    popupMode: popupMode.style.display,
    manualInput: manualInput.style.display,
    reader: reader.style.display,
    overlay: overlay.style.display,
    message: msg.style.display,
  };

  // ‚úÖ ‡∏ã‡πà‡∏≠‡∏ô popupMode ‡πÄ‡∏™‡∏°‡∏≠ (‡πÑ‡∏°‡πà‡∏≠‡∏¢‡∏≤‡∏Å‡πÉ‡∏´‡πâ‡∏ó‡∏±‡∏ö‡∏Å‡∏±‡∏ô)
  popupMode.style.display = 'none';

  // ‚úÖ ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏Ñ‡∏™ redirect (‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤ Form3) ‡∏Ñ‡πà‡∏≠‡∏¢‡∏ã‡πà‡∏≠‡∏ô manual/camera ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
  if(redirect){
    manualInput.style.display = 'none';
    reader.style.display = 'none';
    overlay.style.display = 'none';
    msg.style.display = 'none';
  }

  // --- ‡πÅ‡∏™‡∏î‡∏á popupAlert ---
  const popup = document.getElementById("popupAlert");
  const text = document.getElementById("popupAlertText");
  const btnContainer = document.getElementById("popupAlertButtons");

  text.textContent = message;
  btnContainer.innerHTML = "";
  popup.style.display = "flex";

  setTimeout(async () => {
    popup.style.display = "none";

    if(!redirect){
      // ‚úÖ ‡πÑ‡∏°‡πà redirect ‚Üí ‡∏Ñ‡∏∑‡∏ô UI ‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°
      manualInput.style.display = prev.manualInput;
      reader.style.display = prev.reader;
      overlay.style.display = prev.overlay;
      msg.style.display = prev.message;

      isScanned = false; // ‡πÉ‡∏´‡πâ‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡πÑ‡∏î‡πâ
      return;
    }

    // ‚úÖ redirect ‚Üí ‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤ Form3 ‡∏ï‡∏≤‡∏°‡πÄ‡∏î‡∏¥‡∏°
    await stopCameraSafely();
    window.location.replace("Form3.html");
  }, 2000);
}

  // ‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° Lost ‚Üí ‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤ Losstrackingcode.html
document.getElementById('popupLostBtn').onclick = async () => {
 if(!guardFlowOrRestart()) return;
  touchFlow();

    //  ‡∏Å‡∏±‡∏ô race condition / callback ‡∏¢‡∏¥‡∏á‡∏ã‡πâ‡∏≥
  isScanned = true;
  isStartingCamera = false;
  isCameraRunning = false;
  await stopCameraSafely();

  // ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏≠‡∏≤‡∏à‡∏Ñ‡πâ‡∏≤‡∏á‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡∏≠‡∏Å customer (‡∏Å‡∏±‡∏ô‡∏´‡∏•‡∏≠‡∏ô)
  sessionStorage.removeItem("selectedRow");

  // ‡∏£‡∏∞‡∏ö‡∏∏‡∏ß‡πà‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ tracking
  sessionStorage.setItem("tracking", "UNKNOWN");

  // ‡∏Å‡∏±‡∏ô‡∏™‡πÅ‡∏Å‡∏ô‡∏ã‡πâ‡∏≥
  sessionStorage.setItem("scannedCodes", JSON.stringify(["UNKNOWN"]));

  showAlertPopup("‚ÑπÔ∏è ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏£‡∏∞‡∏ö‡∏∏‡∏£‡∏´‡∏±‡∏™‡∏û‡∏±‡∏™‡∏î‡∏∏‡πÑ‡∏î‡πâ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏û‡∏≤‡πÑ‡∏õ‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‚Ä¶", true);
};


function showPopupWithSelection(dataArray, callback){
  
  const popup = document.getElementById("popupAlert");
  const text = document.getElementById("popupAlertText");
  const btnContainer = document.getElementById("popupAlertButtons");

  // ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ô‡∏≥
  text.textContent = "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡∏≠‡∏á‡∏ó‡πà‡∏≤‡∏ô";

  // ‡∏•‡πâ‡∏≤‡∏á‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏Å‡πà‡∏≤
  btnContainer.innerHTML = "";

  // ‡∏õ‡∏∏‡πà‡∏°‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏ï‡πà‡∏•‡∏∞ Customer
  dataArray.forEach((row) => {
    const btn = document.createElement("button");
    btn.style.margin = "5px 0";
    btn.style.width = "100%";
    btn.style.padding = "10px";
    btn.style.fontSize = "1rem";

     // ‡πÉ‡∏ä‡πâ‡∏ä‡∏∑‡πà‡∏≠ field ‡∏à‡∏£‡∏¥‡∏á‡∏à‡∏≤‡∏Å Apps Script
    const name = row.CustomerName || row.Name || '';
    const code = row.BillingPostCode || row.PostCode || '';
    const tracking = row.TrackingCode || row.Code || '';
    
   btn.textContent = `${name}  ${code}  ${tracking}`;
    btn.onclick = () => {
    popup.style.display = "none";
    if(callback) callback(row);
  };
  btnContainer.appendChild(btn);
});

  // ‡∏õ‡∏∏‡πà‡∏° "‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•"
  const skipBtn = document.createElement("button");
  skipBtn.style.marginTop = "10px";
  skipBtn.style.width = "100%";
  skipBtn.style.padding = "10px";
  skipBtn.style.background = "#FF5722";
  skipBtn.style.color = "white";
  skipBtn.style.fontWeight = "bold";
  skipBtn.textContent = "‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ô";
  
  skipBtn.onclick = async () => {
  popup.style.display = "none";
    
 // üîí ‡∏Å‡∏±‡∏ô race condition / callback ‡∏¢‡∏¥‡∏á‡∏ã‡πâ‡∏≥
  isScanned = true;
  isStartingCamera = false;
  isCameraRunning = false;
  await stopCameraSafely();
    
  sessionStorage.removeItem("selectedRow");
  const t = sessionStorage.getItem("tracking") || "UNKNOWN"; // ‡∏õ‡∏Å‡∏ï‡∏¥‡∏à‡∏∞‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß
  sessionStorage.setItem("scannedCodes", JSON.stringify([t]));

  showAlertPopup("‚ÑπÔ∏è ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ô ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏û‡∏≤‡πÑ‡∏õ‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‚Ä¶", true);
};
  btnContainer.appendChild(skipBtn);

  popup.style.display = "flex";
  }
  
// ‡πÉ‡∏ä‡πâ‡∏Å‡∏±‡∏ö‡∏ó‡∏±‡πâ‡∏á QR ‡πÅ‡∏•‡∏∞ Manual
async function processCode(code){
  if(!guardFlowOrRestart()) return;
  touchFlow();

  code = (code || "").trim();
  if(!code){
    await showAlertPopup("‚ùå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏î‡πâ‡∏ß‡∏¢", false);
    return;
  }
  
  // ‡∏Å‡∏±‡∏ô‡∏ã‡πâ‡∏≥‡∏à‡∏≤‡∏Å callback ‡∏Å‡∏•‡πâ‡∏≠‡∏á
  if(isScanned) return;     // ‡∏Å‡∏±‡∏ô‡∏ã‡πâ‡∏≥
  isScanned = true;         // ‡∏•‡πá‡∏≠‡∏Ñ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ (‡∏ó‡∏±‡πâ‡∏á scan+manual)

  await stopCameraSafely(); // ‡∏´‡∏¢‡∏∏‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á ‡∏•‡∏î‡∏™‡πÅ‡∏Å‡∏ô‡∏ã‡πâ‡∏≥/‡∏Ñ‡πâ‡∏≤‡∏á

  // ‡∏Å‡∏±‡∏ô‡πÄ‡∏Ñ‡∏¢‡∏ó‡∏≥‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡πâ‡∏ß
  const scannedCodes = JSON.parse(sessionStorage.getItem('scannedCodes') || '[]');
  if(scannedCodes.includes(code)) {
   await showAlertPopup("‚ö†Ô∏è ‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏Ñ‡∏¢‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏µ‡πâ‡πÅ‡∏•‡πâ‡∏ß", true);
    return;
  }

  // ‚úÖ ‡πÄ‡∏Å‡πá‡∏ö‡∏Ñ‡πà‡∏≤‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô ‡πÅ‡∏•‡πâ‡∏ß‡πÑ‡∏õ Form3 ‡πÄ‡∏•‡∏¢
  sessionStorage.setItem('tracking', code);
  sessionStorage.setItem("scannedCodes", JSON.stringify([code]));

  // ‚úÖ ‡∏ñ‡πâ‡∏≤ Form3 ‡πÄ‡∏î‡∏¥‡∏° ‚Äú‡∏Ñ‡∏≤‡∏î‡∏´‡∏ß‡∏±‡∏á selectedRow‚Äù ‡πÉ‡∏´‡πâ‡πÉ‡∏™‡πà‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥‡πÑ‡∏ß‡πâ‡∏Å‡∏±‡∏ô‡∏°‡∏±‡∏ô‡∏´‡∏•‡∏≠‡∏ô
  sessionStorage.setItem('selectedRow', JSON.stringify({ TrackingCode: code }));

  // ‡πÇ‡∏ä‡∏ß‡πå‡πÇ‡∏´‡∏•‡∏î‡∏î‡∏¥‡πâ‡∏á 
  showLoadingPopup(true);

  try{
    // ‡∏ñ‡πâ‡∏≤‡∏Ñ‡∏∏‡∏ì‡∏¢‡∏±‡∏á‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏¢‡∏¥‡∏á backend ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å tracking ‡∏Å‡πá‡∏ó‡∏≥‡πÑ‡∏î‡πâ
    // (‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£ ‡∏Å‡πá‡∏•‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏Å‡πâ‡∏≠‡∏ô‡∏ô‡∏µ‡πâ‡∏≠‡∏≠‡∏Å‡πÑ‡∏î‡πâ)
    await fetch('/api/updateTracking', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ tracking: code })
    });
  } catch(err){
    console.error('Update backend failed:', err);
    // ‡∏ñ‡πâ‡∏≤‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å backend ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß ‡∏à‡∏∞‡πÉ‡∏´‡πâ‡∏¢‡∏±‡∏á‡πÑ‡∏õ Form3 ‡πÑ‡∏´‡∏°?
    // - ‡∏ñ‡πâ‡∏≤‡∏à‡∏∞ ‚Äú‡∏¢‡∏±‡∏á‡πÑ‡∏õ‚Äù ‡∏Å‡πá‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á throw
    // - ‡∏ñ‡πâ‡∏≤‡∏à‡∏∞ ‚Äú‡∏´‡∏¢‡∏∏‡∏î‚Äù ‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á error ‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡∏∑‡∏ô UI
    showLoadingPopup(false);
    isScanned = false;
    await showAlertPopup("‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å", false);
    return;
  }

  // ‚úÖ ‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤ Form3 (‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á showAlertPopup ‡∏Å‡πá‡πÑ‡∏î‡πâ)
  await stopCameraSafely();
  window.location.replace("Form3.html");
}

// Scan mode
async function scanQRCode() {
  if(!guardFlowOrRestart()) return;
  touchFlow();
  
  const scannedCodes = JSON.parse(sessionStorage.getItem('scannedCodes') || '[]');
  if(scannedCodes.length > 0){
    showAlertPopup("‚ö†Ô∏è ‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏≥‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß", true);
    return;
  }

  document.getElementById('popupMode').style.display = 'none';
  document.getElementById('reader').style.display = 'block';
  document.getElementById('overlay').style.display = 'block';
  document.getElementById('message').style.display = 'block';

  // ‡πÇ‡∏ä‡∏ß‡πå Manual input ‡∏î‡πâ‡∏ß‡∏¢ (‡∏à‡∏∞‡∏ã‡πà‡∏≠‡∏ô‡∏ï‡∏≠‡∏ô‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πâ)
  document.getElementById('manualInput').style.display = 'flex';
  
  currentMode = "scan";
  isScanned = false;

  // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Å‡∏•‡πâ‡∏≠‡∏á (‡∏°‡∏µ guard ‡∏Å‡∏±‡∏ô‡∏ã‡πâ‡∏≠‡∏ô‡πÅ‡∏•‡πâ‡∏ß)
  await stopCameraSafely();
  await main(); 
  
}

// ‡πÄ‡∏û‡∏¥‡πà‡∏° flag: ‡∏Ñ‡∏∏‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏ä‡∏±‡∏î ‡πÜ
let isStartingCamera = false;
let isCameraRunning = false;

async function stopCameraSafely(){
  try{
    if(html5QrCode && isCameraRunning){
      await html5QrCode.stop();
      await html5QrCode.clear();
    }
  }catch(e){
    console.warn("stopCameraSafely:", e);
  }finally{
    isCameraRunning = false;
    isStartingCamera = false;
  }
}
// ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏´‡∏ô‡πâ‡∏≤ = ‡∏´‡∏¢‡∏∏‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á ‡∏•‡∏î‡πÄ‡∏Ñ‡∏™‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏´‡∏°‡πà‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÑ‡∏°‡πà‡∏°‡∏≤
window.addEventListener("pagehide", () => {
  stopCameraSafely();
});
  
// QR function
async function main() {
  if(!guardFlowOrRestart()) return;
  touchFlow();

  if(isStartingCamera || isCameraRunning) return; // ‚úÖ ‡∏Å‡∏±‡∏ô start ‡∏ã‡πâ‡∏≥
  isStartingCamera = true;

  try{
    if (!html5QrCode) html5QrCode = new Html5Qrcode("reader");

    const config = {
      fps: 10,
      qrbox: (w,h)=>{ const s=w*0.6; return {width:s,height:s}; }
    };

    await html5QrCode.start(
      { facingMode: "environment" },
      config,
    async (qrCodeMessage) => {
      showLoadingPopup(true);
      try{
      touchFlow();
      await processCode(qrCodeMessage);
    } finally {
      showLoadingPopup(false);
    }
  },
      (errorMessage) => { /* ‡πÄ‡∏á‡∏µ‡∏¢‡∏ö‡πÑ‡∏ß‡πâ ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á log ‡πÄ‡∏¢‡∏≠‡∏∞ */ }
    );

    isCameraRunning = true;

  }catch(err){
    console.error("Camera start error:", err);
    sessionStorage.setItem("tracking", sessionStorage.getItem("tracking") || "UNKNOWN");
    showAlertPopup("‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÑ‡∏î‡πâ", true);
    await stopCameraSafely();
  }finally{
    isStartingCamera = false;
  }
}


  
  // ‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Scan / Manual
document.getElementById('popupScanOrManualBtn').onclick = scanQRCode;

  function showLoadingPopup(show = true){
  document.getElementById('popupLoading').style.display = show ? 'flex' : 'none';
}

  document.getElementById('manualCode').addEventListener('focus', async () => {
  await stopCameraSafely();
  document.getElementById('reader').style.display = 'none';
  document.getElementById('overlay').style.display = 'none';
  document.getElementById('message').style.display = 'none';
});

document.getElementById('btnBackToCamera').onclick = async () => {
  if(!guardFlowOrRestart()) return;
  touchFlow();

  // ‡πÉ‡∏´‡πâ‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏™‡πÅ‡∏Å‡∏ô‡πÉ‡∏´‡∏°‡πà‡πÑ‡∏î‡πâ
  isScanned = false;

  const manual = document.getElementById('manualCode');
  // ‡∏ã‡πà‡∏≠‡∏ô keyboard
  manual.blur();
  //  ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏Å‡∏£‡∏≠‡∏Å‡πÑ‡∏ß‡πâ
  manual.value = "";

  // (‡∏ñ‡πâ‡∏≤‡∏≠‡∏¢‡∏≤‡∏Å‡∏ã‡πà‡∏≠‡∏ô manualInput ‡∏ï‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡πÉ‡∏ä‡πâ‡∏Å‡∏•‡πâ‡∏≠‡∏á ‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡∏¥‡∏î‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ô‡∏µ‡πâ)
  // document.getElementById('manualInput').style.display = 'none';

  // ‡πÄ‡∏õ‡∏¥‡∏î UI ‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏Å‡∏•‡∏±‡∏ö
  document.getElementById('reader').style.display = 'block';
  document.getElementById('overlay').style.display = 'block';
  document.getElementById('message').style.display = 'block';

  await stopCameraSafely();
  await main();
};

    //manual + submit
document.getElementById('manualSubmit').onclick=async ()=>{
   if(!guardFlowOrRestart()) return;
  touchFlow();
  
    if(isScanned){
    showAlertPopup("‚ö†Ô∏è ‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏î‡πâ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡πâ‡∏ß", false);
    return;
  }
  const code = document.getElementById('manualCode').value.trim();
  if(!code){
    showAlertPopup("‚ùå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏î‡πâ‡∏ß‡∏¢", false);
    return;
  }

  // ‡πÅ‡∏™‡∏î‡∏á popup ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•
  showLoadingPopup(true);

  try{
    await processCode(code);
  } finally {
    // ‡∏õ‡∏¥‡∏î popup ‡∏´‡∏•‡∏±‡∏á‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÄ‡∏™‡∏£‡πá‡∏à
    showLoadingPopup(false);
  }
};

</script>
</body>
</html>
